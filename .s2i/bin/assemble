#!/bin/bash -e

#
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#   https://github.com/jboss-openshift/cct_module/tree/master/os-java-s2i/added/s2i
#

HOME=/opt/app-root/src

if [ "$(ls -A /tmp/artifacts/ 2>/dev/null)" ]; then
  mkdir -p /tmp/m2 && cp -Rf /tmp/artifacts/* /tmp/m2
fi

/usr/local/s2i/assemble

source /usr/local/s2i/s2i-setup

cd $S2I_SOURCE_DIR/target
unzip component-server.zip
mv component-server-distribution/* $DEPLOYMENTS_DIR
mkdir -p $DEPLOYMENTS_DIR/.m2/repository/org/talend/demo/1.0.0
cp component-runtime-demo-openshift-*.jar $DEPLOYMENTS_DIR/.m2/repository/org/talend/demo/1.0.0/demo-1.0.0.jar
cd -

cat > $DEPLOYMENTS_DIR/bin/setenv.sh << EOF
#! /bin/sh
export MEECROWAVE_OPTS="$MEECROWAVE_OPTS -Dtalend.component.server.maven.repository=$MEECROWAVE_BASE/.m2"
export MEECROWAVE_OPTS="$MEECROWAVE_OPTS -Dtalend.component.server.component.coordinates=org.talend:demo:1.0.0"
export MEECROWAVE_OPTS="$MEECROWAVE_OPTS -Dtalend.component.server.documentation.active=true"
EOF

mvn clean
find /tmp/artifacts/m2 -name ''*SNAPSHOT' | xargs rm -Rf
