#!/bin/bash -e

#
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#

HOME=/opt/app-root/src
DEPLOY_DIR=/opt/openshift

if [ "$(ls -A /tmp/artifacts/ 2>/dev/null)" ]; then
  mkdir -p /tmp/m2 && cp -Rf /tmp/artifacts/* /tmp/m2
fi

/usr/local/s2i/assemble

cd target
unzip component-server.zip
mv component-server-distribution/* $DEPLOY_DIR
mkdir -p $DEPLOY_DIR/.m2/repository/org/talend/demo/1.0.0
cp target/component-runtime-demo-openshift-*.jar $DEPLOY_DIR/.m2/repository/org/talend/demo/1.0.0/demo-1.0.0.jar

cat > $DEPLOY_DIR/bin/setenv.sh << EOF
#! /bin/sh
export MEECROWAVE_OPTS="$MEECROWAVE_OPTS -Dtalend.component.server.maven.repository=$MEECROWAVE_BASE/.m2"
export MEECROWAVE_OPTS="$MEECROWAVE_OPTS -Dtalend.component.server.component.coordinates=org.talend:demo:1.0.0"
export MEECROWAVE_OPTS="$MEECROWAVE_OPTS -Dtalend.component.server.documentation.active=true"
EOF
